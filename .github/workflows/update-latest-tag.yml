name: Update 'latest' Tag

on:
  push:
    branches: [ main ]
  release:
    types: [ published, edited ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional: source tag to point `latest` to. If empty the workflow will use the release tag (for release events) or the most recent tag.'
        required: false

permissions:
  contents: write

jobs:
  update-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Update or create refs/tags/latest (using PAT if available)
        uses: actions/github-script@v6
        env:
          PAT_TRIGGER: ${{ secrets.PAT_TRIGGER }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Use PAT if provided to perform release/tag operations (events created by a PAT will trigger other workflows)
            const pat = process.env.PAT_TRIGGER;
            let octokit = github;
            if (pat) {
              const { Octokit } = require('@octokit/rest');
              octokit = new Octokit({ auth: pat });
              console.log('Using PAT_TRIGGER for authenticated operations (will trigger release events).');
            } else {
              console.log('PAT_TRIGGER not found; operations will use GITHUB_TOKEN (events may not trigger other workflows).');
            }

            let sourceTag = '';
            let sha = '';

            if (context.eventName === 'push') {
              // On push to main, use the pushed commit as the source
              sha = context.payload.after;
              console.log(`Running on push event. Using push SHA: ${sha}`);
            } else {
              if (context.eventName === 'release') {
                sourceTag = context.payload.release.tag_name;
              } else if (context.eventName === 'workflow_dispatch') {
                sourceTag = (context.payload && context.payload.inputs && context.payload.inputs.tag) ? context.payload.inputs.tag : '';
              }

              if (!sourceTag) {
                const tags = await github.rest.repos.listTags({ owner, repo, per_page: 1 });
                if (tags.data.length === 0) throw new Error('No tags found in the repository to use as source.');
                sourceTag = tags.data[0].name;
              }

              console.log(`Using source tag: ${sourceTag}`);

              // Resolve tag -> commit SHA
              try {
                const ref = await github.rest.git.getRef({ owner, repo, ref: `tags/${sourceTag}` });
                const obj = ref.data.object;
                if (obj.type === 'tag') {
                  // annotated tag -> resolve to commit
                  const tagObj = await github.rest.git.getTag({ owner, repo, tag_sha: obj.sha });
                  sha = tagObj.data.object.sha;
                } else {
                  // lightweight tag
                  sha = obj.sha;
                }
              } catch (err) {
                // fallback: list tags and find commit sha
                const list = await github.rest.repos.listTags({ owner, repo, per_page: 100 });
                const found = list.data.find(t => t.name === sourceTag);
                if (!found) throw new Error(`Failed to resolve tag ${sourceTag}: ${err.message}`);
                sha = found.commit.sha;
              }

              console.log(`Resolved SHA: ${sha}`);
            }

            // Update refs/tags/latest (force) or create if missing using octokit (PAT if available)
            try {
              await octokit.rest.git.updateRef({ owner, repo, ref: 'tags/latest', sha, force: true });
              console.log('Updated refs/tags/latest (via octokit)');
            } catch (err) {
              await octokit.rest.git.createRef({ owner, repo, ref: 'refs/tags/latest', sha });
              console.log('Created refs/tags/latest (via octokit)');
            }

            // Confirm the refs/tags/latest points to the expected SHA and print hash
            try {
              const latestRef = await octokit.rest.git.getRef({ owner, repo, ref: 'tags/latest' });
              const latestSha = latestRef.data.object.sha;
              console.log(`Resolved SHA: ${sha}`);
              console.log(`refs/tags/latest now points to: ${latestSha}`);
              console.log(`refs/tags/latest short: ${latestSha.substring(0,7)}`);

              // Update or create a Release for tag 'latest' and write the resolved SHA into its body (do NOT copy assets)
              try {
                try {
                  const release = await octokit.rest.repos.getReleaseByTag({ owner, repo, tag: 'latest' });
                  console.log(`Found existing release id=${release.data.id} for tag 'latest'`);

                  const oldBody = release.data.body || '';
                  const line = `**latest tag commit:** ${sha} (short: ${sha.substring(0,7)})`;

                  // replace existing line if any, otherwise append
                  const newBody = oldBody.replace(/\*\*latest tag commit:\*\*.*(?:\r\n|\n)?/i, `${line}\n`);
                  const finalBody = (newBody === oldBody) ? (oldBody + `\n\n${line}`) : newBody;

                  await octokit.rest.repos.updateRelease({ owner, repo, release_id: release.data.id, body: finalBody });
                  console.log('Updated release body for tag latest (via octokit)');
                } catch (getErr) {
                  // If not found, create a release with tag 'latest' (assets should be uploaded by the build job)
                  const createResp = await octokit.rest.repos.createRelease({ owner, repo, tag_name: 'latest', name: 'latest', body: `**latest tag commit:** ${sha} (short: ${sha.substring(0,7)})`, draft: false, prerelease: false, target_commitish: sha });
                  console.log(`Created release for tag 'latest' id=${createResp.data.id} (via octokit)`);
                console.log('Warning: failed to update/create release for tag latest:', err.message);
              }

            } catch (err) {
              console.log('Warning: failed to fetch refs/tags/latest after update:', err.message);
            }
