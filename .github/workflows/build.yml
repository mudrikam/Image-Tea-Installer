name: Build Image Tea Installer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Build Windows executable
        run: pyinstaller --onefile --noupx --icon=image_tea.ico --add-data "installer_configs.json;." --name=Image_Tea_Installer image_tea_installer.py

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: Image-Tea-Installer-Windows
          path: dist/Image_Tea_Installer.exe
          if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Build macOS .app bundle
        run: |
          pyinstaller --windowed --onedir --noupx \
            --icon=image_tea.icns \
            --add-data "installer_configs.json:." \
            --name="Image Tea Installer" \
            image_tea_installer.py

      - name: Create DMG (optional, or just zip the .app)
        run: |
          cd dist
          zip -r "Image_Tea_Installer.app.zip" "Image Tea Installer.app"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: Image-Tea-Installer-macOS
          path: dist/Image_Tea_Installer.app.zip
          if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install pyinstaller
          sudo apt-get update
          sudo apt-get install -y wget file

      - name: Build Linux executable with PyInstaller
        run: |
          pyinstaller --onedir --noupx \
            --add-data "installer_configs.json:." \
            --name=Image_Tea_Installer \
            image_tea_installer.py

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications
          
          # Copy the PyInstaller bundle
          cp -r dist/Image_Tea_Installer/* AppDir/usr/bin/
          
          # Copy icon
          cp image-tea.png AppDir/usr/share/icons/hicolor/256x256/apps/image-tea.png
          cp image-tea.png AppDir/image-tea.png
          
          # Create .desktop file
          cat > AppDir/usr/share/applications/image-tea-installer.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=Image Tea Installer
          Exec=Image_Tea_Installer
          Icon=image-tea
          Categories=Utility;
          Terminal=true
          EOF
          
          # Create AppRun launcher
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/Image_Tea_Installer" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # Copy desktop file to root
          cp AppDir/usr/share/applications/image-tea-installer.desktop AppDir/

      - name: Create AppImage
        env:
          ARCH: x86_64
        run: |
          APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool-x86_64.AppImage AppDir Image_Tea_Installer-x86_64.AppImage

      - name: Make AppImage executable
        run: chmod +x Image_Tea_Installer-x86_64.AppImage

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: Image-Tea-Installer-Linux
          path: Image_Tea_Installer-x86_64.AppImage
          if-no-files-found: error
