name: Build Image Tea Installer

on:
  release:
    types: [ published, edited ]
  workflow_dispatch:
  workflow_run:
    workflows:
      - Update 'latest' Tag
    types:
      - completed

permissions:
  contents: write

jobs:
  build-windows:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout latest tag when triggered by Update latest Tag
        if: ${{ github.event_name == 'workflow_run' }}
        run: |
          git fetch --tags
          git checkout tags/latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Build Windows executable
        run: pyinstaller --onefile --noupx --icon=image_tea.ico --add-data "installer_configs.json;." --name=Image_Tea_Installer image_tea_installer.py

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: Image-Tea-Installer-Windows
          path: dist/Image_Tea_Installer.exe
          if-no-files-found: error

      - name: Upload to Release
        if: github.event_name == 'release' || github.event_name == 'workflow_run'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/Image_Tea_Installer.exe
          tag_name: ${{ github.event_name == 'workflow_run' && 'latest' || github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: Image-Tea-Installer-Windows
          failOnError: false

  build-macos:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout latest tag when triggered by Update latest Tag
        if: ${{ github.event_name == 'workflow_run' }}
        run: |
          git fetch --tags
          git checkout tags/latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Build macOS executable
        run: |
          pyinstaller --onefile --noupx \
            --icon=image_tea.icns \
            --add-data "installer_configs.json:." \
            --name=Image_Tea_Installer \
            image_tea_installer.py

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: Image-Tea-Installer-macOS
          path: dist/Image_Tea_Installer
          if-no-files-found: error

      - name: Upload to Release
        if: github.event_name == 'release' || github.event_name == 'workflow_run'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/Image_Tea_Installer
          tag_name: ${{ github.event_name == 'workflow_run' && 'latest' || github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: Image-Tea-Installer-macOS
          failOnError: false

  build-linux:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout latest tag when triggered by Update latest Tag
        if: ${{ github.event_name == 'workflow_run' }}
        run: |
          git fetch --tags
          git checkout tags/latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install pyinstaller
          sudo apt-get update
          sudo apt-get install -y wget file

      - name: Build Linux executable with PyInstaller
        run: |
          pyinstaller --onedir --noupx \
            --add-data "installer_configs.json:." \
            --name=Image_Tea_Installer \
            image_tea_installer.py

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications
          
          # Copy the PyInstaller bundle
          cp -r dist/Image_Tea_Installer/* AppDir/usr/bin/
          
          # Copy icon
          cp image-tea.png AppDir/usr/share/icons/hicolor/256x256/apps/image-tea.png
          cp image-tea.png AppDir/image-tea.png
          
          # Create .desktop file
          cat > AppDir/usr/share/applications/image-tea-installer.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=Image Tea Installer
          Exec=Image_Tea_Installer
          Icon=image-tea
          Categories=Utility;
          Terminal=true
          EOF
          
          # Create AppRun launcher
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/Image_Tea_Installer" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # Copy desktop file to root
          cp AppDir/usr/share/applications/image-tea-installer.desktop AppDir/

      - name: Create AppImage
        env:
          ARCH: x86_64
        run: |
          APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool-x86_64.AppImage AppDir Image_Tea_Installer-x86_64.AppImage

      - name: Make AppImage executable
        run: chmod +x Image_Tea_Installer-x86_64.AppImage

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: Image-Tea-Installer-Linux
          path: Image_Tea_Installer-x86_64.AppImage
          if-no-files-found: error

      - name: Upload to Release
        if: github.event_name == 'release' || github.event_name == 'workflow_run'
        uses: softprops/action-gh-release@v2
        with:
          files: Image_Tea_Installer-x86_64.AppImage
          tag_name: ${{ github.event_name == 'workflow_run' && 'latest' || github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: Image-Tea-Installer-Linux
          failOnError: false
